# 家庭功能测试文档

## 一、测试环境配置

### 1.1 后端服务
- **API地址**: `http://139.129.108.119:8080`
- **API文档**: `http://139.129.108.119:8080/swagger-ui.html`

### 1.2 测试账号
| 角色 | 手机号 | 密码 | 用途 |
|------|--------|------|------|
| 用户A (管理员) | 13800138000 | abc123456 | 创建家庭、管理成员 |
| 用户B (成员) | 13900139000 | xyz123456 | 加入家庭、退出家庭 |
| 用户C (成员) | 13700137000 | qwe123456 | 二次加入、被移除测试 |

---

## 二、API接口列表

### 2.1 认证接口
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/auth/login` | 用户登录获取Token |

### 2.2 家庭管理接口
| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| POST | `/api/family/create` | 创建家庭 | 任意用户 |
| GET | `/api/family/my` | 获取我的家庭信息 | 家庭成员 |
| GET | `/api/family/qrcode` | 获取家庭邀请二维码 | 仅管理员 |
| GET | `/api/family/info/{code}` | 解析邀请码（预览） | 无需登录 |
| POST | `/api/family/join` | 通过邀请码加入家庭 | 无家庭用户 |
| POST | `/api/family/leave` | 退出当前家庭 | 家庭成员 |
| GET | `/api/family/members` | 获取家庭成员列表 | 家庭成员 |
| DELETE | `/api/family/members/{targetUserId}` | 移除成员 | 仅管理员 |
| PUT | `/api/family/name` | 更新家庭名称 | 仅管理员 |

---

## 三、测试场景

### 3.1 场景一：创建家庭流程

**步骤**:
1. 用户A登录获取Token和UserId
2. 用户A调用创建家庭接口
3. 验证返回的家庭信息（家庭名、邀请码、角色为管理员）

**预期结果**:
- 创建成功，返回家庭ID
- 用户A自动成为管理员
- 生成6位邀请码（大写字母+数字）

**测试命令**:
```bash
curl -X POST "http://139.129.108.119:8080/api/family/create" \
  -H "Content-Type: application/json" \
  -H "X-User-Id: {用户A的ID}" \
  -d '{"familyName":"温馨小家"}'
```

---

### 3.2 场景二：扫码加入流程

**步骤**:
1. 用户A获取家庭二维码
2. 用户B扫描二维码或输入邀请码
3. 解析邀请码获取家庭预览信息
4. 用户B确认加入
5. 双方都能看到更新后的成员列表

**预期结果**:
- 二维码包含格式: `FAMILY_INVITE:{邀请码}`
- 预览信息显示家庭名和成员数
- 用户B成功加入，角色为普通成员
- 成员列表显示两个成员

**测试命令**:
```bash
# 获取二维码
curl -X GET "http://139.129.108.119:8080/api/family/qrcode" \
  -H "X-User-Id: {用户A的ID}"

# 解析邀请码
curl -X GET "http://139.129.108.119:8080/api/family/info/ABC123" \
  -H "Content-Type: application/json"

# 加入家庭
curl -X POST "http://139.129.108.119:8080/api/family/join" \
  -H "Content-Type: application/json" \
  -H "X-User-Id: {用户B的ID}" \
  -d '{"inviteCode":"ABC123"}'
```

---

### 3.3 场景三：成员管理流程

**步骤**:
1. 管理员获取成员列表
2. 管理员移除某个成员
3. 被移除成员无法再访问家庭信息
4. 成员数相应减少

**预期结果**:
- 仅管理员可执行移除操作
- 普通成员尝试移除返回权限错误
- 被移除成员调用家庭接口返回无家庭错误

**测试命令**:
```bash
# 获取成员列表
curl -X GET "http://139.129.108.119:8080/api/family/members" \
  -H "X-User-Id: {管理员ID}"

# 移除成员
curl -X DELETE "http://139.129.108.119:8080/api/family/members/{被移除用户ID}" \
  -H "X-User-Id: {管理员ID}"
```

---

### 3.4 场景四：退出家庭流程

**步骤**:
1. 普通成员发起退出
2. 成员列表更新
3. 退出后的成员不再有家庭信息

**预期结果**:
- 成功退出，返回成功消息
- 管理员无法退出（除非先转让或解散）
- 退出后无法访问家庭接口

**测试命令**:
```bash
curl -X POST "http://139.129.108.119:8080/api/family/leave" \
  -H "X-User-Id: {成员ID}"
```

---

### 3.5 场景五：双设备协作测试

**设备配置**:
| 设备 | 用户 | 操作 |
|------|------|------|
| 设备A | 用户A | 创建家庭、获取二维码 |
| 设备B | 用户B | 扫码加入、查看成员 |

**测试步骤**:
1. **设备A**: 创建家庭，记下邀请码
2. **设备B**: 输入邀请码，预览家庭信息
3. **设备B**: 确认加入
4. **设备A**: 刷新成员列表，验证看到用户B
5. **设备B**: 查看成员列表，验证看到用户A
6. **设备A**: 更新家庭名称
7. **设备B**: 刷新，验证看到新名称

---

## 四、边界条件测试

### 4.1 输入验证
| 测试项 | 输入 | 预期结果 |
|--------|------|----------|
| 空家庭名 | `""` | 返回"家庭名称不能为空" |
| 超长家庭名 | 101字符 | 返回"最多100个字符" |
| 空邀请码 | `""` | 返回"邀请码不能为空" |
| 错误格式邀请码 | `abc123` | 返回"只能包含大写字母和数字" |
| 不存在的邀请码 | `ZZZZZZ` | 返回"邀请码无效" |
| 已有家庭用户加入 | 任意 | 返回"您已加入其他家庭" |

### 4.2 权限测试
| 操作 | 角色 | 预期结果 |
|------|------|----------|
| 获取二维码 | 管理员 | 成功返回 |
| 获取二维码 | 普通成员 | 返回权限错误 |
| 移除成员 | 管理员 | 成功移除 |
| 移除成员 | 普通成员 | 返回权限错误 |
| 更新家庭名 | 管理员 | 成功更新 |
| 更新家庭名 | 普通成员 | 返回权限错误 |

### 4.3 状态测试
| 状态 | 操作 | 预期结果 |
|------|------|----------|
| 无家庭用户 | 获取家庭信息 | 返回"未加入任何家庭" |
| 无家庭用户 | 获取二维码 | 返回"未加入任何家庭" |
| 无家庭用户 | 退出家庭 | 返回"未加入任何家庭" |
| 已有家庭 | 加入其他家庭 | 返回"您已加入其他家庭" |
| 唯一管理员 | 退出家庭 | 返回"管理员无法退出" |

---

## 五、错误处理测试

### 5.1 预期错误码
| 错误码 | 说明 | 场景 |
|--------|------|------|
| 1001 | 用户不存在 | 用户ID无效 |
| 1002 | 家庭不存在 | 家庭ID无效 |
| 1003 | 邀请码无效 | 邀请码格式错误或不存在 |
| 1004 | 已有家庭 | 用户已加入其他家庭 |
| 1005 | 无权限 | 普通成员执行管理员操作 |
| 1006 | 成员不存在 | 目标成员不在家庭中 |

### 5.2 测试用例
```bash
# 测试无效邀请码
curl -X POST "http://139.129.108.119:8080/api/family/join" \
  -H "Content-Type: application/json" \
  -H "X-User-Id: {用户B的ID}" \
  -d '{"inviteCode":"INVALID"}'

# 测试重复加入
curl -X POST "http://139.129.108.119:8080/api/family/join" \
  -H "Content-Type: application/json" \
  -H "X-User-Id: {已加入用户ID}" \
  -d '{"inviteCode":"ABC123"}'

# 测试非管理员移除成员
curl -X DELETE "http://139.129.108.119:8080/api/family/members/{目标ID}" \
  -H "X-User-Id: {普通成员ID}"
```

---

## 六、执行测试

### 6.1 使用自动化脚本

**Windows**:
```cmd
cd D:\ReadHealthInfo\flutter-app
test-family-api.bat
```

**Linux/Mac**:
```bash
cd D:\ReadHealthInfo/flutter-app
chmod +x test-family-api.sh
./test-family-api.sh
```

### 6.2 手动测试步骤

1. **准备阶段**: 确保测试账号已注册
2. **执行脚本**: 运行测试脚本
3. **检查输出**: 查看每个API的返回结果
4. **验证数据**: 确认返回数据格式正确
5. **保存结果**: 脚本会生成所有响应的JSON文件

---

## 七、测试检查清单

### 7.1 功能检查清单
- [ ] 用户可以创建家庭
- [ ] 创建后用户自动成为管理员
- [ ] 管理员可以获取家庭二维码
- [ ] 二维码内容格式正确（FAMILY_INVITE:{code}）
- [ ] 用户可以通过邀请码加入家庭
- [ ] 加入后用户角色为普通成员
- [ ] 双方都能在成员列表中看到对方
- [ ] 管理员可以移除成员
- [ ] 普通成员可以退出家庭
- [ ] 管理员可以更新家庭名称
- [ ] 退出后无法访问家庭信息
- [ ] 已有家庭用户无法加入其他家庭

### 7.2 边界条件检查清单
- [ ] 空家庭名被拒绝
- [ ] 超长家庭名被拒绝
- [ ] 空邀请码被拒绝
- [ ] 错误格式邀请码被拒绝
- [ ] 不存在的邀请码被拒绝
- [ ] 普通成员无法获取二维码
- [ ] 普通成员无法移除成员
- [ ] 普通成员无法更新家庭名

### 7.3 错误处理检查清单
- [ ] 所有错误返回统一格式
- [ ] 错误消息清晰明确
- [ ] 错误码定义完整
- [ ] 不影响其他正常操作

---

## 八、测试数据示例

### 8.1 家庭创建响应示例
```json
{
  "code": 200,
  "message": "家庭创建成功",
  "data": {
    "id": "1",
    "familyName": "温馨小家",
    "familyCode": "ABC123",
    "adminId": "1",
    "adminNickname": "张三",
    "memberCount": 1,
    "createTime": "2024-01-01T10:00:00",
    "myRole": "admin"
  }
}
```

### 8.2 二维码响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "familyCode": "ABC123",
    "qrContent": "FAMILY_INVITE:ABC123",
    "familyName": "温馨小家",
    "memberCount": 1
  }
}
```

### 8.3 成员列表响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "1",
      "phone": "13800138000",
      "nickname": "张三",
      "avatar": null,
      "gender": "male",
      "birthday": "1990-01-01",
      "familyRole": "admin",
      "joinTime": "2024-01-01T10:00:00",
      "isMe": true
    },
    {
      "id": "2",
      "phone": "13900139000",
      "nickname": "李四",
      "avatar": null,
      "gender": "female",
      "birthday": null,
      "familyRole": "member",
      "joinTime": "2024-01-01T11:00:00",
      "isMe": false
    }
  ]
}
```

---

## 九、问题记录模板

| 序号 | 问题描述 | 复现步骤 | 预期结果 | 实际结果 | 严重程度 | 状态 |
|------|----------|----------|----------|----------|----------|------|
| 1 | | | | | | |
| 2 | | | | | | |

---

## 十、测试报告模板

### 测试概况
- 测试日期:
- 测试人员:
- 测试环境:
- 测试版本:

### 测试结果
| 模块 | 测试用例数 | 通过 | 失败 | 通过率 |
|------|------------|------|------|--------|
| 创建家庭 | | | | |
| 加入家庭 | | | | |
| 成员管理 | | | | |
| 权限控制 | | | | |
| 错误处理 | | | | |
| **合计** | | | | |

### 问题汇总
- 严重问题:
- 一般问题:
- 建议优化:
